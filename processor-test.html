<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processoræ¶ˆæ¯æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .file-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ Processoræ¶ˆæ¯æ¥æ”¶æµ‹è¯•é¡µé¢</h1>
        <div class="info">
            <strong>æµ‹è¯•URL:</strong> <span id="currentUrl"></span><br>
            <strong>é¡µé¢çŠ¶æ€:</strong> <span id="pageStatus"></span><br>
            <strong>ç›‘å¬å™¨çŠ¶æ€:</strong> <span id="listenerStatus">æœªåˆå§‹åŒ–</span>
        </div>

        <div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="testMessage()">æµ‹è¯•å‘é€æ¶ˆæ¯</button>
            <button onclick="checkWindow()">æ£€æŸ¥Windowå¯¹è±¡</button>
        </div>

        <div id="logContainer" class="log"></div>

        <div id="fileInfo" class="file-info" style="display: none;">
            <h3>æ¥æ”¶çš„æ–‡ä»¶ä¿¡æ¯:</h3>
            <p><strong>æ–‡ä»¶å:</strong> <span id="fileName"></span></p>
            <p><strong>å¹³å°:</strong> <span id="platform"></span></p>
            <p><strong>å†…å®¹é•¿åº¦:</strong> <span id="contentLength"></span></p>
            <p><strong>å†…å®¹é¢„è§ˆ:</strong></p>
            <div id="contentPreview" style="background: #f8f9fa; padding: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 11px;"></div>
        </div>
    </div>

    <script>
        let messageCount = 0;
        const logContainer = document.getElementById('logContainer');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            console.log(message);
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            logContainer.textContent = '';
            document.getElementById('fileInfo').style.display = 'none';
        }

        function checkWindow() {
            log('=== Windowå¯¹è±¡æ£€æŸ¥ ===');
            log(`extensionFileDataå­˜åœ¨: ${!!window.extensionFileData}`);
            if (window.extensionFileData) {
                log(`extensionFileDataå†…å®¹: ${JSON.stringify(window.extensionFileData, null, 2)}`);
                // å¤„ç†windowå¯¹è±¡ä¸­çš„æ•°æ®
                handlePluginMessage({ data: window.extensionFileData });
                delete window.extensionFileData;
            }
            log(`hasMessageListener: ${!!window.hasMessageListener}`);
            log('=== æ£€æŸ¥å®Œæˆ ===');
        }

        function testMessage() {
            const testData = {
                type: 'PLUGIN_FILE_DATA',
                content: '# æµ‹è¯•æ–‡ä»¶\n\nè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶å†…å®¹ã€‚\n\n## ç¬¬äºŒæ®µ\n\nåŒ…å«ä¸€äº›ç¤ºä¾‹æ–‡æœ¬ã€‚',
                filename: 'test-file.md',
                platform: 'Test'
            };
            
            log('ğŸ§ª å‘é€æµ‹è¯•æ¶ˆæ¯...');
            window.postMessage(testData, '*');
        }

        function handlePluginMessage(event) {
            messageCount++;
            log(`ğŸ”Œ æ¥æ”¶åˆ°ç¬¬${messageCount}ä¸ªæ¶ˆæ¯:`, 'success');
            log(`æ¶ˆæ¯æ¥æº: ${event.origin || 'æœ¬åœ°'}`);
            log(`æ¶ˆæ¯æ•°æ®: ${JSON.stringify(event.data, null, 2)}`);

            // éªŒè¯æ¶ˆæ¯æ ¼å¼
            if (event.data && event.data.type === 'PLUGIN_FILE_DATA') {
                log('âœ… æ’ä»¶æ–‡ä»¶æ•°æ®æ¶ˆæ¯éªŒè¯é€šè¿‡', 'success');
                
                const { content, filename, platform } = event.data;
                
                log(`æ–‡ä»¶å: ${filename}`);
                log(`å¹³å°: ${platform}`);
                log(`å†…å®¹é•¿åº¦: ${content?.length || 0} å­—ç¬¦`);
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                displayFileInfo(filename, platform, content);
                
                // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ å¤„ç†
                simulateFileUpload(content, filename, platform);
                
            } else {
                log('âŒ éæ’ä»¶æ¶ˆæ¯æˆ–æ ¼å¼é”™è¯¯', 'error');
                log(`æ¥æ”¶åˆ°çš„type: ${event.data?.type || 'æœªå®šä¹‰'}`);
            }
        }

        function displayFileInfo(filename, platform, content) {
            document.getElementById('fileName').textContent = filename || 'æœªçŸ¥';
            document.getElementById('platform').textContent = platform || 'æœªçŸ¥';
            document.getElementById('contentLength').textContent = (content?.length || 0) + ' å­—ç¬¦';
            
            const preview = content ? content.substring(0, 500) + (content.length > 500 ? '\n...(å†…å®¹è¢«æˆªæ–­)' : '') : 'æ— å†…å®¹';
            document.getElementById('contentPreview').textContent = preview;
            
            document.getElementById('fileInfo').style.display = 'block';
        }

        function simulateFileUpload(content, filename, platform) {
            log('ğŸ“ å¼€å§‹æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ ...', 'info');
            
            if (!content || !filename) {
                log('âŒ æ–‡ä»¶æ•°æ®ä¸å®Œæ•´', 'error');
                return;
            }
            
            log(`âœ… æ–‡ä»¶å¤„ç†æˆåŠŸ: ${filename} (${platform || 'æœªçŸ¥å¹³å°'})`, 'success');
            log('ğŸ“ æ–‡ä»¶å·²å‡†å¤‡å¥½è¿›è¡Œåç»­å¤„ç†');
        }

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('pageStatus').textContent = document.readyState;
            
            log('ğŸ”„ é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
            log(`å½“å‰URL: ${window.location.href}`);
            log(`é¡µé¢çŠ¶æ€: ${document.readyState}`);
            
            // æ ‡è®°æœ‰æ¶ˆæ¯ç›‘å¬å™¨
            window.hasMessageListener = true;
            
            // æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨
            window.addEventListener('message', handlePluginMessage);
            log('âœ… æ¶ˆæ¯ç›‘å¬å™¨å·²æ·»åŠ ');
            document.getElementById('listenerStatus').textContent = 'å·²æ¿€æ´»';
            
            // æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
            window.addEventListener('extensionFileData', (event) => {
                log('ğŸ¯ æ¥æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶');
                handlePluginMessage({ data: event.detail, origin: 'custom-event' });
            });
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®åœ¨windowå¯¹è±¡ä¸­
            setTimeout(() => {
                if (window.extensionFileData) {
                    log('ğŸ” å‘ç°windowå¯¹è±¡ä¸­çš„æ•°æ®ï¼Œè‡ªåŠ¨å¤„ç†...');
                    handlePluginMessage({ data: window.extensionFileData, origin: 'window-object' });
                    delete window.extensionFileData;
                }
            }, 1000);
            
            log('ğŸ§ å¼€å§‹ç›‘å¬æ’ä»¶æ¶ˆæ¯...');
            log('ğŸ“‹ é¡µé¢å·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ‰©å±•ç¨‹åºæ¶ˆæ¯');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPage);
        } else {
            initPage();
        }

        // é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡æ£€æŸ¥
        window.addEventListener('load', () => {
            log('ğŸ‰ é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');
            document.getElementById('pageStatus').textContent = 'complete';
        });
    </script>
</body>
</html>